---
title: "Snowpark Container Serviceä¸Šã§Rstudioã‚’æ‰±ã†"
emoji: "ğŸ’­"
type: "tech"
topics: [snowflake, Container, R, Rstudio, Bioinformatics]
published: true
---
## ã¯ã˜ã‚ã«
ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ˜¯æã§ã™ã€‚
çš†ã•ã‚“SPCSã¯ä½¿ã£ã¦ã„ã¾ã™ã‹ï¼Ÿã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä»¥å¤–ã«ã‚‚ãƒ‡ãƒ¼ã‚¿è§£æã«ä½¿ã„ãŸã„ã¨ã„ã†æ–¹ã¯ã„ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ã“ã®è¨˜äº‹ã§ã¯ã€SPCSã§Rstudioã‚’ä½¿ã†æ–¹æ³•ã‚’è©¦ã—ãŸã®ã§ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚Rstudio Serverã®imageã‚’snowflakeã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ä½¿ã„ã¾ã™ã€‚
snowflakeç•Œéšˆã«ã¯Rãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãªã‹ãªã‹ã„ã¾ã›ã‚“ãŒã€Rä½¿ã£ã¦ã¿ãŸã„æ–¹ã¯ãœã²å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## snowflakeä¸Šã§è¡Œã†SPCSè¨­å®š

snowflakeä¸Šã§è¡Œã†SPCSè¨­å®šæ–¹æ³•ã§ã™ãŒã€ã“ã¡ã‚‰ã«ã¾ã¨ã‚ã¾ã—ãŸã®ã§çœç•¥ã•ã›ãŸé ‚ãã¾ã™ã€‚
https://zenn.dev/t_koreeda/articles/3437ca8c0eddfc#snowflake%E3%81%AE%E5%90%84%E7%A8%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B

ä»Šå›ã¯è§£æã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚ä½¿ã„ãŸã„ã®ã§ã€STAGEã‚’`ENCRYPTION = (TYPE = 'SNOWFLAKE_SSE');`ã‚’æŒ‡å®šã—ã¦ä½œã‚Šç›´ã—ã¦ãŠãã¾ã™ã€‚
ã¡ãªã¿ã«snowflakeã§ä½¿ã†ãƒœãƒªãƒ¥ãƒ¼ãƒ ã§ã¯å¤–éƒ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
```sql
DROP STAGE tutorial_stage;
CREATE STAGE tutorial_stage
  DIRECTORY = ( ENABLE = true )
  ENCRYPTION = (TYPE = 'SNOWFLAKE_SSE');
```
å‚è€ƒï¼šhttps://qiita.com/ak-sakatoku/items/ccfc32f11b110e83c1e0
https://docs.snowflake.com/en/developer-guide/snowpark-container-services/specification-reference#label-snowpark-containers-spec-volume

## SPCSã§ä½¿ã†image
SPCSä¸Šä½¿ã†Rstudio Serverã®imageã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸå¾Œã€IMAGE REPOSITORYã«Pushã—ã¾ã™ã€‚

```bash
#imageã®pull
docker pull kinngut/single-cell:latest
#tagä»˜ã‘
docker tag kinngut/single-cell:latest <registry_hostname>/tutorial_db/data_schema/tutorial_repository/kinngut/single-cell:latest
# login
docker login <registry_hostname> -u dev_admin
# push
docker push <registry_hostname>/tutorial_db/data_schema/tutorial_repository/kinngut/single-cell:latest
```
<registry_hostname>ã¯ SHOW IMAGE REPOSITORIES SQL ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒã‚¸ãƒˆãƒª URL ã¨ã—ã¦å–å¾—ã•ã‚Œã‚‹URLã§ã™ã€‚URLå†…ã®ãƒ›ã‚¹ãƒˆåã¯ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®ãƒ›ã‚¹ãƒˆåã§ã™ã€‚ï¼ˆä¾‹ï¼šmyorg-myacct.registry.snowflakecomputing.comï¼‰


## ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ
ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚è§£æç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã§ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

```yaml
CREATE SERVICE singlecell
IN COMPUTE POOL tutorial_compute_pool
FROM SPECIFICATION $$
spec:
  containers:
  - name: singlecell
    image: <registry_hostname>/tutorial_db/data_schema/tutorial_repository/kinngut/single-cell:latest
    env:
      DISABLE_AUTH: true
    volumeMounts:
    - name: rstudio
      mountPath: /rstudio/data
  endpoints:
  - name: rstudioendpoint
    port: 8787
    public: true
  volumes:
  - name: rstudio
    source: "@TUTORIAL_DB.DATA_SCHEMA.tutorial_STAGE"
    uid: 0
    gid: 0
$$
MIN_INSTANCES=1
MAX_INSTANCES=1;
```

specã®è§£èª¬ã‚’ã—ã¾ã™ã€‚

**containers**
ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®šã‚’å«ã¿ã¾ã™ã€‚ã“ã“ã§ã¯ã€`singlecell`ã¨ã„ã†åå‰ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
  - **name**: ã‚³ãƒ³ãƒ†ãƒŠã®åå‰ã§ã™ã€‚
  - **image**: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®å ´æ‰€ã‚’æŒ‡å®šã—ã¾ã™ã€‚
  - **env**: ã‚³ãƒ³ãƒ†ãƒŠå†…ã§è¨­å®šã•ã‚Œã‚‹ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚`DISABLE_AUTH`ã‚’`true`ã«è¨­å®šã—ã¦RStudio Serverã§ã®èªè¨¼ã‚’å¤–ã—ã¦ã„ã¾ã™ã€‚
  - **volumeMounts**: ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç‰¹å®šã®ãƒ‘ã‚¹ã«ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹è¨­å®šã§ã™ã€‚
    - **name**: ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®åå‰ã§ã™ã€‚
    - **mountPath**: ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ãƒ‘ã‚¹ã§ã™ã€‚

**endpoints**
ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚
  - **name**: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®åå‰ã§ã™ã€‚
  - **port**: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·ã§ã™ã€‚
  - **public**: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã—ã¾ã™ã€‚`true`ã®å ´åˆã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚

**volumes**
ã‚µãƒ¼ãƒ“ã‚¹ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®è¨­å®šã§ã™ã€‚
  - **name**: ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®åå‰ã§ã™ã€‚
  - **source**: ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€Snowflakeã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚
  - **uid**: ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®æ‰€æœ‰è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™ã€‚
  - **gid**: ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®æ‰€æœ‰è€…ã®ã‚°ãƒ«ãƒ¼ãƒ—IDã§ã™ã€‚

**MIN_INSTANCES**,**MAX_INSTANCES**
ã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè¡Œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ€å°æ•°ã¨æœ€å¤§æ•°ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã¨å¯ç”¨æ€§ãŒç®¡ç†ã•ã‚Œã¾ã™ã€‚

## Rstudio Serverã‚’èµ·å‹•
Rstudio Serverã‚’èµ·å‹•ã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
```sql
SHOW ENDPOINTS IN SERVICE <ã‚µãƒ¼ãƒ“ã‚¹å>;
```
æœ€åˆã¯ã€ŒEndpoints provisioning in progress... check back in a few minutesã€ã®è¡¨ç¤ºãŒå‡ºã¾ã™ãŒã€æ•°åˆ†å¾…ã£ã¦ã¿ã‚‹ã¨ã€Œingress_urlã€åˆ—ã§ç„¡äº‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æŒ‡å®šã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€snowflakeãƒ¦ãƒ¼ã‚¶ãƒ¼ã§èªè¨¼ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
![](https://storage.googleapis.com/zenn-user-upload/f8baa1f7a678-20240212.png)

RstudioãŒé–‹ã‘ã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/f4daa949700f-20240212.png)

äºˆã‚specã§è¨­å®šã—ãŸã‚¹ãƒ†ãƒ¼ã‚¸ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€Rstudioã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã«è¨­å®šã—ãŸãƒ‘ã‚¹ã®ä½ç½®ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºèªã§ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/8562c3a67cda-20240213.png)

```bash
rstudio@statefulset-0:~$ cd /rstudio/data
rstudio@statefulset-0:/rstudio/data$ ls
barcodes.tsv.gz  features.tsv.gz
```
ã‚‚ã—ã€250MBã‚’è¶…ãˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†…éƒ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å ´åˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§snowSQLã‚’èµ·å‹•ã—ã€PUTã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã®ã§ãŠæ°—ã‚’ã¤ã‘ãã ã•ã„ã€‚

```sql
snowsql -a [ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå] -u [ãƒ¦ãƒ¼ã‚¶ãƒ¼å]
PUT file://[ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹] @TUTORIAL_DB.DATA_SCHEMA.tutorial_STAGE;
```

çµæœ
```
dev_admin#(no warehouse)@(no database).(no schema)>PUT file:///Users/t_koreeda/desktop/r/matrix.mtx.gz
                                                    @TUTORIAL_DB.DATA_SCHEMA.tutorial_STAGE;
+---------------+---------------+-------------+-------------+--------------------+--------------------+----------+---------+
| source        | target        | source_size | target_size | source_compression | target_compression | status   | message |
|---------------+---------------+-------------+-------------+--------------------+--------------------+----------+---------|
| matrix.mtx.gz | matrix.mtx.gz |   489938709 |   489938709 | GZIP               | GZIP               | UPLOADED |         |
+---------------+---------------+-------------+-------------+--------------------+--------------------+----------+---------+
1 Row(s) produced. Time Elapsed: 25.100s

```

å‚è€ƒï¼š
https://docs.snowflake.com/en/user-guide/data-load-local-file-system-stage-ui?css#uploading-files-onto-a-stage
https://docs.snowflake.com/en/user-guide/data-load-local-file-system-stage#staging-the-data-files


## Rstudioã§irisãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–
Rã§ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨è¨€ã£ãŸã‚‰irisãƒ‡ãƒ¼ã‚¿ãŒæœ‰åã§ã™ã€‚æ—©é€Ÿggplot2ã§å¯è¦–åŒ–ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

```r
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  install.packages("ggplot2")
}

# ggplot2ã‚’ãƒ­ãƒ¼ãƒ‰
library(ggplot2)

# irisãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦æ•£å¸ƒå›³ã‚’ä½œæˆ
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +
  geom_point() +
  theme_minimal() +
  labs(title = "Iris Dataset: Sepal Length vs Sepal Width",
       x = "Sepal Length",
       y = "Sepal Width")

```
irisãƒ‡ãƒ¼ã‚¿ã‚‚å•é¡Œãªãå¯è¦–åŒ–ã•ã‚Œã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/ac42a76984ac-20240213.png)

## Rstudio Serverã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Rstudioã§packageã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã£ã¦è¦‹ãŸã¨ã“ã‚ã€ã„ãã¤ã‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚cranã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚
å†…éƒ¨ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã«åˆ¶é™ãŒã‹ã‹ã£ã¦ã„ãã†ãªã®ã§ã€å›é¿æ–¹æ³•ã‚’æ¢ç´¢ä¸­ã§ã™ï¼ˆsnowflakeã®ã‚µãƒãƒ¼ãƒˆã«å•ã„åˆã‚ã›ä¸­ï¼‰ã€‚

```bash
> install.packages("remotes")
Warning in install.packages :
  unable to access index for repository http://cran.rstudio.com/src/contrib:
  cannot open URL 'http://cran.rstudio.com/src/contrib/PACKAGES'
Installing package into â€˜/usr/local/lib/R/site-libraryâ€™
(as â€˜libâ€™ is unspecified)
Warning in install.packages :
  unable to access index for repository http://cran.rstudio.com/src/contrib:
  cannot open URL 'http://cran.rstudio.com/src/contrib/PACKAGES'
Warning in install.packages :
  package â€˜remotesâ€™ is not available for this version of R

A version of this package for your version of R might be available elsewhere,
see the ideas at
https://cran.r-project.org/doc/manuals/r-devel/R-admin.html#Installing-packages
```

ãŠãã‚‰ããƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¦External Access INTEGRATIONã¨ã„ã£ãŸæ“ä½œãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã“ã¡ã‚‰ã¯å¼•ãç¶šãèª¿æŸ»ã—ã¦ã¾ã„ã‚Šã¾ã™ã€‚
https://docs.snowflake.com/en/developer-guide/snowpark-container-services/additional-considerations-services-jobs#network-egress

## æœ€å¾Œã«
ã„ã‹ãŒã ã£ãŸã§ã—ã‚‡ã†ã‹ã€‚ã“ã‚Œã¾ã§snowflakeã§ã¯Pythonã®ä½¿ç”¨ãŒå¤šã‹ã£ãŸã¨æ€ã„ã¾ã™ãŒã€SPCSã®ãŠã‹ã’ã§ä»–ã®è¨€èªã‚‚ä½¿ã„ã‚„ã™ããªã£ã¦ãŠã‚Šã¾ã™ã€‚
ãœã²ã¨ã‚‚è‡ªåˆ†ã®ãŠæ°—ã«å…¥ã‚Šè¨€èªã‚’SPCSã§ä½¿ãˆã‚‹ã‚ˆã†ã«ç’°å¢ƒæ§‹ç¯‰ã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã§ã¯ã€ã‚ˆã„SPCSãƒ©ã‚¤ãƒ•ã‚’ï¼